<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人脸识别管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
            --dark-color: #212529;
            --light-color: #f8f9fa;
            --tech-bg: #0a192f;
            --tech-card: #112240;
            --tech-text: #ccd6f6;
            --tech-highlight: #64ffda;
            --tech-border: #233554;
        }
        
        body {
            background-color: var(--tech-bg);
            color: var(--tech-text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .navbar {
            background-color: rgba(10, 25, 47, 0.95) !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid var(--tech-border);
        }
        
        .navbar-brand {
            color: var(--tech-highlight) !important;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .card {
            background-color: var(--tech-card);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            border: 1px solid var(--tech-border);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        
        .card-header {
            background-color: rgba(17, 34, 64, 0.7);
            border-bottom: 1px solid var(--tech-border);
            font-weight: 600;
            color: var(--tech-highlight);
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            height: 350px;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--tech-border);
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid var(--tech-highlight);
        }
        
        .detection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .face-box {
            position: absolute;
            border: 3px solid var(--tech-highlight);
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(100, 255, 218, 0.7);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 10px rgba(100, 255, 218, 0.7); }
            50% { box-shadow: 0 0 20px rgba(100, 255, 218, 0.9); }
            100% { box-shadow: 0 0 10px rgba(100, 255, 218, 0.7); }
        }
        
        .btn-action {
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #0b5ed7;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #157347;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: var(--dark-color);
        }
        
        .btn-warning:hover {
            background-color: #ffb020;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #bb2d3b;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background-color: var(--info-color);
        }
        
        .btn-info:hover {
            background-color: #31d2f2;
            transform: translateY(-2px);
        }
        
        .result-container {
            min-height: 120px;
            background-color: rgba(17, 34, 64, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--tech-border);
        }
        
        .user-table img {
            transition: transform 0.3s;
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid var(--tech-highlight);
        }
        /* 优化用户列表可读性 */
        .user-table thead th {
            color: #e6f1ff;
        }
        .user-table tbody td {
            color: #d0e0ff;
        }
        .table > :not(caption) > * > * {
            border-bottom: 1px solid rgba(100, 255, 218, 0.2);
        }
        
        .user-table img:hover {
            transform: scale(2.5);
            z-index: 10;
        }
        
        .highlight {
            background-color: rgba(100, 255, 218, 0.15) !important;
            border-left: 4px solid var(--tech-highlight);
        }
        
        .modal-content {
            background-color: var(--tech-card);
            color: var(--tech-text);
        }
        
        .modal-header {
            border-bottom: 1px solid var(--tech-border);
        }
        
        .modal-footer {
            border-top: 1px solid var(--tech-border);
        }
        
        .form-control, .form-select {
            background-color: rgba(10, 25, 47, 0.5);
            border: 1px solid var(--tech-border);
            color: var(--tech-text);
        }
        
        .form-control:focus {
            background-color: rgba(10, 25, 47, 0.7);
            border-color: var(--tech-highlight);
            box-shadow: 0 0 0 0.25rem rgba(100, 255, 218, 0.25);
            color: var(--tech-text);
        }
        
        .table {
            color: var(--tech-text);
        }
        
        .table > :not(caption) > * > * {
            background-color: transparent;
            border-bottom: 1px solid var(--tech-border);
        }
        
        .table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: rgba(17, 34, 64, 0.3);
        }
        
        .table-hover > tbody > tr:hover > * {
            background-color: rgba(100, 255, 218, 0.1);
        }
        
        .alert {
            border-radius: 8px;
            border: none;
        }
        
        .alert-success {
            background-color: rgba(25, 135, 84, 0.2);
            color: #75b798;
        }
        
        .alert-danger {
            background-color: rgba(220, 53, 69, 0.2);
            color: #ea868f;
        }
        
        .alert-warning {
            background-color: rgba(255, 193, 7, 0.2);
            color: #ffecb5;
        }
        
        .alert-info {
            background-color: rgba(13, 202, 240, 0.2);
            color: #9eeaf9;
        }
        
        .face-preview {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            border: 1px solid var(--tech-border);
        }
        
        .tech-header {
            text-align: center;
            margin-bottom: 36px;
            position: relative;
        }
        
        .tech-header h1 {
            font-size: 2.6rem;
            font-weight: 800;
            background: linear-gradient(90deg, var(--tech-highlight), var(--info-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }
        
        .tech-header p {
            color: var(--tech-text);
            opacity: 0.8;
            font-size: 1.1rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .action-buttons .btn {
            flex: 1;
            min-width: 220px;
            padding: 14px 22px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* 霓虹渐变科技风按钮 */
        .btn-neo {
            position: relative;
            color: #0b1529;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(100,255,218,0.9), rgba(13,202,240,0.9));
            box-shadow: 0 8px 24px rgba(100, 255, 218, 0.25), inset 0 0 0 1px rgba(255,255,255,0.15);
            transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
            overflow: hidden;
        }
        .btn-neo:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 32px rgba(13, 202, 240, 0.35), 0 0 20px rgba(100,255,218,0.25);
            filter: brightness(1.03);
        }
        .btn-neo:active { transform: translateY(0); filter: brightness(0.98); }
        .btn-neo i { font-size: 1.2rem; }

        .btn-neo-success {
            background: linear-gradient(135deg, #64ffda, #31d2f2);
            color: #04202b;
        }
        .btn-neo-primary {
            background: linear-gradient(135deg, #6ea8fe, #64ffda);
            color: #04121a;
        }
        
        .recognition-result {
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-success {
            background-color: rgba(25, 135, 84, 0.2);
            border: 1px solid #198754;
            color: #75b798;
        }
        
        .result-warning {
            background-color: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            color: #ffecb5;
        }
        
        .result-info {
            background-color: rgba(13, 202, 240, 0.2);
            border: 1px solid #0dcaf0;
            color: #9eeaf9;
        }
        
        .auto-capture-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(220, 53, 69, 0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            z-index: 100;
            display: none;
        }
        
        .auto-capture-indicator.active {
            display: block;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        /* 人脸保持提示样式 */
        .hold-still-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(13, 110, 253, 0.85);
            color: #fff;
            padding: 8px 16px;
            border-radius: 16px;
            font-weight: 600;
            display: none;
            z-index: 101;
        }
        .hold-still-indicator.active { display: block; }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-person-badge"></i> 人脸识别管理系统
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="tech-header">
            <h1>人脸识别管理系统</h1>
            <p>基于AI技术的智能人脸识别与用户管理平台</p>
        </div>
        
        <!-- 操作按钮区域 -->
        <div class="action-buttons">
            <button id="recognize-btn" class="btn btn-neo btn-neo-success btn-lg">
                <i class="bi bi-camera-video"></i> 人脸识别
            </button>
            <button id="add-user-btn" class="btn btn-neo btn-neo-primary btn-lg">
                <i class="bi bi-person-plus"></i> 新增用户
            </button>
        </div>

        <!-- 用户列表 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">用户列表</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover user-table">
                                <thead>
                                    <tr>
                                        <th>头像</th>
                                        <th>姓名</th>
                                        <th>手机号</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="user-list">
                                    <!-- 用户数据将通过JS动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 摄像头模态框 -->
    <div class="modal fade" id="cameraModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cameraModalLabel">摄像头</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="camera-container">
                        <video id="video" width="100%" height="100%" autoplay muted playsinline></video>
                        <canvas id="canvas" style="display:none;"></canvas>
                        <div class="detection-overlay" id="detection-overlay"></div>
                        <div class="auto-capture-indicator" id="auto-capture-indicator">自动拍照中...</div>
                        <div class="hold-still-indicator" id="hold-still-indicator">请保持正脸稳定 1 秒</div>
                    </div>
                    <div class="d-flex justify-content-between mt-3">
                        <button id="capture" class="btn btn-success btn-action" style="display:none;">
                            <i class="bi bi-camera"></i> 手动拍照
                        </button>
                    </div>
                    
                    <!-- 结果显示区域 -->
                    <div class="result-container mt-3" id="result-container">
                        <p class="text-center text-muted">等待操作...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增用户模态框 -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-user-form">
                        <div class="mb-3">
                            <label class="form-label">姓名</label>
                            <input type="text" class="form-control" id="add-name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">手机号</label>
                            <input type="tel" class="form-control" id="add-phone" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">人脸图像</label>
                            <button type="button" id="capture-face-btn" class="btn btn-primary w-100">
                                <i class="bi bi-camera-video"></i> 录入人脸
                            </button>
                            <div class="text-center mt-2">
                                <img id="new-face-preview" class="face-preview" src="" alt="人脸预览" style="display: none;">
                            </div>
                            <div class="form-text text-info mt-1">可选：不上传人脸也可先保存基本信息</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-user-btn">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 更新用户信息模态框 -->
    <div class="modal fade" id="updateUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">更新用户信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="update-user-form">
                        <input type="hidden" id="update-user-id">
                        <div class="mb-3">
                            <label class="form-label">姓名</label>
                            <input type="text" class="form-control" id="update-name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">手机号</label>
                            <input type="tel" class="form-control" id="update-phone" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">人脸图像</label>
                            <div class="text-center">
                                <img id="current-face-preview" class="face-preview mb-2" src="" alt="当前人脸图像">
                            </div>
                            <button type="button" id="update-face-btn" class="btn btn-warning w-100">
                                <i class="bi bi-camera-video"></i> 更新人脸
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-update-btn">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载必要的JavaScript库 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 使用兼容的TensorFlow.js和face-api.js版本，确保只加载一次 -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.4/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <script>
        // 初始化脚本（位于 body 末尾，DOM 已可用）
            // 全局变量
            let currentUser = null;
            let currentFaceImage = null;
            let isModelsLoaded = false;
            let faceDetectionInterval = null;
            let currentOperation = ''; // 'recognize', 'add', 'update'
            let autoCaptureTimer = null;
            let detectionEnabled = false;
            let allowAutoCapture = false; // 仅在需要拍照识别时为 true
            let originModalId = null; // 记录从哪个业务弹框打开的摄像头（'addUserModal' | 'updateUserModal')
            const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<?xml version="1.0" encoding="UTF-8"?><svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop offset="0%" stop-color="#64ffda"/><stop offset="100%" stop-color="#0dcaf0"/></linearGradient></defs><circle cx="50" cy="50" r="48" fill="#112240" stroke="#233554" stroke-width="2"/><circle cx="50" cy="42" r="16" fill="url(#g)" opacity="0.85"/><path d="M20 82c6-14 20-22 30-22s24 8 30 22" fill="url(#g)" opacity="0.35"/></svg>`);

            // 初始化页面（修复：不要在 load 内再监听 DOMContentLoaded，否则不会触发）
            // 加载用户列表（避免未初始化的默认参数，显式传入）
            loadUsers(0, 8);
            
            // 初始化face-api.js模型
            loadFaceAPIModels();
            
            // 事件监听
            document.getElementById('recognize-btn').addEventListener('click', function() {
                console.log('Recognize button clicked');
                // 重置所有相关状态
                currentOperation = 'recognize';
                allowAutoCapture = true; // 首次点击识别，启动一次自动拍照
                hasRecognizedOnce = false; // 重置识别状态
                currentFaceImage = null; // 清除之前的人脸图像
                console.log('allowAutoCapture set to true');
                const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
                cameraModal.show();
            });
            
            document.getElementById('add-user-btn').addEventListener('click', function() {
                // 打开前清空表单与预览，避免残留上次的人脸
                document.getElementById('add-user-form').reset();
                const preview = document.getElementById('new-face-preview');
                preview.src = '';
                preview.style.display = 'none';
                currentFaceImage = null;
                // 重置所有相关状态
                allowAutoCapture = false;
                currentOperation = '';
                const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
                modal.show();
            });
            
            document.getElementById('capture').addEventListener('click', captureFace);
            document.getElementById('capture-face-btn').addEventListener('click', function() {
                // 重置所有相关状态
                allowAutoCapture = true;
                currentOperation = 'add';
                originModalId = 'addUserModal';
                currentFaceImage = null; // 清除之前的人脸图像
                // 隐藏业务弹框，打开摄像头弹框
                bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
                cameraModal.show();
            });
            document.getElementById('update-face-btn').addEventListener('click', function() {
                // 重置所有相关状态
                currentOperation = 'update';
                originModalId = 'updateUserModal';
                allowAutoCapture = true; // 添加这行以启用自动拍照
                currentFaceImage = null; // 清除之前的人脸图像
                bootstrap.Modal.getInstance(document.getElementById('updateUserModal')).hide();
                const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
                cameraModal.show();
            });
            
            document.getElementById('save-user-btn').addEventListener('click', addUser);
            document.getElementById('save-update-btn').addEventListener('click', updateUser);

            // 当摄像头模态框显示时，自动开启摄像头
            document.getElementById('cameraModal').addEventListener('shown.bs.modal', function () {
                console.log('Camera modal shown, starting camera');
                // 重置所有相关状态
                detectionEnabled = true;
                currentFaceImage = null;
                startCamera();
            });

            // 加载用户列表
            let currentPage = 0;
            let pageSize = 8;
            let totalPages = 0;

            async function loadUsers(page = 0, size = pageSize) {
                try {
                    const response = await fetch(`/api/users?page=${page}&size=${size}`);
                    const payload = await response.json();
                    const pageData = payload.data || { content: payload, totalPages: 1, number: 0 };
                    const users = pageData.content || [];
                    currentPage = pageData.number || 0;
                    totalPages = pageData.totalPages || 1;
                    const userList = document.getElementById('user-list');
                    userList.innerHTML = '';
                    
                    users.forEach(user => {
                        const avatarSrc = user.faceData ? `data:image/jpeg;base64,${user.faceData}` : DEFAULT_AVATAR;
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><img src="${avatarSrc}" alt="用户头像"></td>
                            <td>${user.name}</td>
                            <td>${user.phone}</td>
                            <td>
                                <button class="btn btn-sm btn-info update-user" data-id="${user.id}" data-name="${user.name}" data-phone="${user.phone}" data-face="${user.faceData}">更新</button>
                                <button class="btn btn-sm btn-danger delete-user" data-id="${user.id}">删除</button>
                            </td>
                        `;
                        userList.appendChild(row);
                    });
                    
                    // 添加更新和删除事件
                    document.querySelectorAll('.update-user').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const userId = this.getAttribute('data-id');
                            const userName = this.getAttribute('data-name');
                            const userPhone = this.getAttribute('data-phone');
                            const userFace = this.getAttribute('data-face');
                            
                            document.getElementById('update-user-id').value = userId;
                            document.getElementById('update-name').value = userName;
                            document.getElementById('update-phone').value = userPhone;
                            document.getElementById('current-face-preview').src = userFace ? ('data:image/jpeg;base64,' + userFace) : DEFAULT_AVATAR;
                            
                            currentUser = {
                                id: userId,
                                name: userName,
                                phone: userPhone,
                                faceData: userFace
                            };
                            
                            // 重置人脸图像状态
                            currentFaceImage = null;
                            
                            const modal = new bootstrap.Modal(document.getElementById('updateUserModal'));
                            modal.show();
                        });
                    });
                    
                    document.querySelectorAll('.delete-user').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const userId = this.getAttribute('data-id');
                            deleteUser(userId);
                        });
                    });

                    renderPagination();
                } catch (error) {
                    console.error('加载用户列表失败:', error);
                    showResult('加载用户列表失败: ' + error.message, 'error');
                }
            }

            function renderPagination() {
                let pager = document.getElementById('pager');
                if (!pager) {
                    const container = document.querySelector('.table-responsive');
                    pager = document.createElement('div');
                    pager.id = 'pager';
                    pager.className = 'd-flex justify-content-between align-items-center mt-3';
                    container.appendChild(pager);
                }
                pager.innerHTML = `
                    <div class="text-muted">第 ${currentPage + 1} / ${Math.max(totalPages,1)} 页</div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-info" id="prev-page" ${currentPage <= 0 ? 'disabled' : ''}><i class="bi bi-chevron-left"></i> 上一页</button>
                        <button class="btn btn-sm btn-outline-info" id="next-page" ${currentPage >= totalPages - 1 ? 'disabled' : ''}>下一页 <i class="bi bi-chevron-right"></i></button>
                    </div>
                `;
                document.getElementById('prev-page').onclick = () => {
                    if (currentPage > 0) loadUsers(currentPage - 1, pageSize);
                };
                document.getElementById('next-page').onclick = () => {
                    if (currentPage < totalPages - 1) loadUsers(currentPage + 1, pageSize);
                };
            }

            // 删除用户
            async function deleteUser(userId) {
                if (!confirm('确定要删除这个用户吗？此操作无法撤销。')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/users/${userId}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        showResult('用户删除成功', 'success');
                        loadUsers(); // 刷新用户列表
                    } else {
                        throw new Error(result.message || '删除失败');
                    }
                } catch (error) {
                    console.error('删除用户失败:', error);
                    showResult('删除用户失败: ' + error.message, 'error');
                }
            }

            // 新增用户
            async function addUser() {
                const name = document.getElementById('add-name').value;
                const phone = document.getElementById('add-phone').value;
                
                if (!name || !phone) {
                    showResult('请填写完整的用户信息', 'error');
                    return;
                }
                
                try {
                    const base64Data = currentFaceImage ? currentFaceImage.split(',')[1] : null;
                    
                    const response = await fetch('/api/faces/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: name,
                            phone: phone,
                            faceData: base64Data
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        showResult('用户新增成功', 'success');
                        
                        // 关闭模态框
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
                        modal.hide();
                        
                        // 重置表单
                        document.getElementById('add-user-form').reset();
                        document.getElementById('new-face-preview').style.display = 'none';
                        currentFaceImage = null;
                        
                        // 重新加载用户列表
                        loadUsers();
                    } else {
                        throw new Error(result.message || '新增失败');
                    }
                } catch (error) {
                    console.error('新增用户失败:', error);
                    showResult('新增用户失败: ' + error.message, 'error');
                }
            }

            // 更新用户
            async function updateUser() {
                const userId = document.getElementById('update-user-id').value;
                const name = document.getElementById('update-name').value;
                const phone = document.getElementById('update-phone').value;
                
                try {
                    // 准备更新数据
                    let requestData = {
                        name: name,
                        phone: phone
                    };
                    
                    // 如果更新了人脸，则添加人脸数据
                    if (currentFaceImage) {
                        const base64Data = currentFaceImage.split(',')[1];
                        requestData.faceData = base64Data;
                    }
                    
                    const response = await fetch(`/api/users/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        showResult('用户信息更新成功', 'success');
                        
                        // 关闭模态框
                        const modal = bootstrap.Modal.getInstance(document.getElementById('updateUserModal'));
                        modal.hide();
                        
                        // 重置人脸图像
                        currentFaceImage = null;
                        
                        // 重新加载用户列表
                        loadUsers();
                    } else {
                        throw new Error(result.message || '更新失败');
                    }
                } catch (error) {
                    console.error('更新用户失败:', error);
                    showResult('更新用户失败: ' + error.message, 'error');
                }
            }

            // 加载face-api.js模型
            async function loadFaceAPIModels() {
                try {
                    showResult('正在加载人脸检测模型...', 'info');

                    // 确保TensorFlow.js已加载并设置后端
                    if (typeof tf === 'undefined') {
                        throw new Error('TensorFlow.js未正确加载');
                    }
                    try {
                        await tf.setBackend('webgl');
                    } catch (e) {
                        console.warn('WebGL 后端不可用，降级到 CPU:', e);
                        await tf.setBackend('cpu');
                    }
                    await tf.ready();

                    // 使用正确的模型路径
                    const modelPath = '/models';

                    // 只加载必要的人脸检测模型，避免重复加载
                    try {
                        // 检查模型是否已加载
                        if (!faceapi.nets.tinyFaceDetector.isLoaded) {
                            await faceapi.nets.tinyFaceDetector.loadFromUri(modelPath);
                            showResult('人脸检测模型加载成功', 'success');
                        } else {
                            showResult('人脸检测模型已加载', 'success');
                        }
                    } catch (error) {
                        console.error('加载人脸检测模型失败:', error);
                        showResult('加载人脸检测模型失败: ' + error.message, 'error');
                        return;
                    }

                    isModelsLoaded = true;
                    showResult('模型加载完成，可以开始使用', 'success');
                    
                    // 启用所有需要模型的功能
                    enableModelDependentFeatures();
                } catch (error) {
                    console.error('加载模型失败:', error);
                    showResult('模型加载失败: ' + error.message, 'error');
                }
            }
            
            // 启用依赖模型的功能
            function enableModelDependentFeatures() {
                // 这里可以启用依赖模型的功能按钮
                console.log('模型依赖功能已启用');
            }

            // 开启摄像头
            async function startCamera() {
                console.log('startCamera called, isModelsLoaded:', isModelsLoaded);
                if (!isModelsLoaded) {
                    showResult('模型尚未加载完成，请稍后再试', 'error');
                    return;
                }
                
                try {
                    const video = document.getElementById('video');
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 640 }, 
                            height: { ideal: 480 },
                            facingMode: 'user'
                        }, 
                        audio: false 
                    });
                    
                    video.srcObject = stream;
                    
                    // 等待视频加载完成后再开始检测
                    video.onloadedmetadata = () => {
                        console.log('Video metadata loaded');
                        // 延迟一小段时间确保视频完全加载
                        setTimeout(() => {
                            // 自动开始人脸检测
                            detectionEnabled = true;
                            startFaceDetection();
                        }, 1000); // 增加延迟时间确保模型完全初始化
                    };
                    
                    showResult('摄像头已开启，正在检测人脸...', 'info');
                } catch (error) {
                    console.error('开启摄像头失败:', error);
                    showResult('开启摄像头失败: ' + error.message, 'error');
                }
            }

            // 开始人脸检测
            function startFaceDetection() {
                console.log('startFaceDetection called, detectionEnabled:', detectionEnabled);
                const video = document.getElementById('video');
                const overlay = document.getElementById('detection-overlay');
                const autoCaptureIndicator = document.getElementById('auto-capture-indicator');
                const holdStillIndicator = document.getElementById('hold-still-indicator');
                
                // 清除之前的检测间隔
                if (faceDetectionInterval) {
                    clearInterval(faceDetectionInterval);
                }
                
                // 等待视频元数据加载完成
                if (video.readyState < video.HAVE_METADATA) {
                    video.addEventListener('loadedmetadata', () => {
                        runFaceDetection();
                    });
                } else {
                    runFaceDetection();
                }
                
                function runFaceDetection() {
                    console.log('runFaceDetection called');
                    // 设置检测间隔
                    faceDetectionInterval = setInterval(async () => {
                        console.log('Face detection interval running, detectionEnabled:', detectionEnabled);
                        if (video.readyState >= video.HAVE_METADATA && detectionEnabled) {
                            try {
                                // 确保视频有尺寸信息
                                if (video.videoWidth > 0 && video.videoHeight > 0) {
                                    // 只使用tinyFaceDetector进行人脸检测，提高性能
                                    const detections = await faceapi.detectAllFaces(
                                        video, 
                                        new faceapi.TinyFaceDetectorOptions({ inputSize: 416, scoreThreshold: 0.5 })
                                    );
                                    console.log('Detections found:', detections.length);
                                    
                                    // 清除之前的检测框
                                    overlay.innerHTML = '';
                                    
                                    // 获取视频元素的实际显示尺寸
                                    const displaySize = {
                                        width: video.offsetWidth,
                                        height: video.offsetHeight
                                    };
                                    
                                    // 获取视频的原始尺寸
                                    const videoSize = {
                                        width: video.videoWidth,
                                        height: video.videoHeight
                                    };
                                    
                                    // 计算缩放比例（用于调试/备用）
                                    const scaleX = displaySize.width / videoSize.width;
                                    const scaleY = displaySize.height / videoSize.height;
                                    
                                    let faceDetected = false;
                                    
                                    // 只有在检测到人脸时才绘制框和执行自动拍照
                                    if (detections.length > 0) {
                                        faceDetected = true;
                                        
                                        // 将检测结果调整为显示尺寸，避免重复缩放导致偏移
                                        const resizedDetections = faceapi.resizeResults(detections, displaySize);
                                        
                                        // 绘制检测框（直接使用显示尺寸坐标）
                                        resizedDetections.forEach(detection => {
                                            const box = detection.box;
                                            const faceBox = document.createElement('div');
                                            faceBox.className = 'face-box';
                                            faceBox.style.width = `${box.width}px`;
                                            faceBox.style.height = `${box.height}px`;
                                            faceBox.style.left = `${box.x}px`;
                                            faceBox.style.top = `${box.y}px`;
                                            overlay.appendChild(faceBox);
                                        });
                                    }
                                    
                                    // 自动拍照逻辑：只在首次稳定检测到人脸时启动一次定时器
                                    if (faceDetected) {
                                        // 显示保持提示，直到自动拍照触发
                                        holdStillIndicator.classList.add('active');
                                        if (allowAutoCapture && !autoCaptureTimer) {
                                            console.log('Setting up auto capture timer');
                                            autoCaptureTimer = setTimeout(() => {
                                                console.log('Auto capture triggered');
                                                autoCaptureIndicator.classList.add('active');
                                                captureFace();
                                                setTimeout(() => {
                                                    autoCaptureIndicator.classList.remove('active');
                                                }, 2000);
                                                // 拍照完成后清理定时器，避免重复触发
                                                autoCaptureTimer = null;
                                                holdStillIndicator.classList.remove('active');
                                                allowAutoCapture = false; // 一次拍照后关闭，等待"再次识别"开启
                                            }, 1000); // 连续检测约1秒后拍照
                                        }
                                    } else {
                                        // 没有检测到人脸，清除自动拍照定时器
                                        if (autoCaptureTimer) {
                                            clearTimeout(autoCaptureTimer);
                                            autoCaptureTimer = null;
                                        }
                                        holdStillIndicator.classList.remove('active');
                                    }
                                    
                                    // 内存管理由 face-api.js 内部 tidy 处理
                                } // end if (video.videoWidth > 0 && video.videoHeight > 0)
                            } catch (error) {
                                console.error('人脸检测出错:', error);
                                // 继续执行，不中断检测循环
                            }
                        } // end if (video.readyState >= video.HAVE_METADATA && detectionEnabled)
                    }, 200); // 每200ms检测一次，提高检测频率
                }

            }

            // 拍照
            function captureFace() {
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                const context = canvas.getContext('2d');
                
                // 设置canvas尺寸与视频一致
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // 绘制当前视频帧到canvas
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // 转换为base64
                currentFaceImage = canvas.toDataURL('image/jpeg');
                
                showResult('照片已捕获', 'success');
                
                // 根据操作类型执行相应功能
                if (currentOperation === 'recognize') {
                    // 修复：确保识别人脸功能被正确调用
                    setTimeout(() => {
                        recognizeFace();
                    }, 100); // 添加小延迟确保状态更新
                } else if (currentOperation === 'update' && currentUser) {
                    // 在更新用户模态框中显示预览
                    document.getElementById('current-face-preview').src = currentFaceImage;
                    // 关闭摄像头并返回来源弹框
                    const originId = originModalId; originModalId = null;
                    const cameraModal = bootstrap.Modal.getInstance(document.getElementById('cameraModal'));
                    cameraModal.hide();
                    if (originId) {
                        const backModal = new bootstrap.Modal(document.getElementById(originId));
                        backModal.show();
                    }
                } else if (currentOperation === 'add') {
                    // 在新增用户模态框中显示预览
                    const preview = document.getElementById('new-face-preview');
                    preview.src = currentFaceImage;
                    preview.style.display = 'block';
                    
                    // 关闭摄像头并返回来源弹框
                    const originId = originModalId; originModalId = null;
                    const cameraModal = bootstrap.Modal.getInstance(document.getElementById('cameraModal'));
                    cameraModal.hide();
                    if (originId) {
                        const backModal = new bootstrap.Modal(document.getElementById(originId));
                        backModal.show();
                    }
                }
            }

            // 识别人脸（识别只触发一次，如需再次识别使用按钮）
            let hasRecognizedOnce = false;
            async function recognizeFace() {
                // 修复：确保函数被正确调用
                console.log('recognizeFace function called');
                
                if (hasRecognizedOnce) {
                    console.log('Recognition already done once');
                    return;
                }
                if (!currentFaceImage) {
                    showResult('请先拍照捕获人脸图像', 'error');
                    return;
                }
                
                try {
                    showResult('正在识别人脸，请稍候...', 'info');
                    
                    // 提取base64数据
                    const base64Data = currentFaceImage.split(',')[1];
                    
                    const response = await fetch('/api/faces/recognize', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            faceData: base64Data
                        })
                    });
                    
                    const result = await response.json();
                    console.log('Recognition API response:', result);
                    
                    if (response.ok) {
                        hasRecognizedOnce = true;
                        if (result.data && result.data.length > 0) {
                            const bestMatch = result.data[0];
                            // 修复：确保相似度字段正确显示
                            const similarity = bestMatch.similar !== undefined ? bestMatch.similar : bestMatch.confidence;
                            showRecognitionResult(`识别成功: 最匹配用户 ${bestMatch.userName} (相似度: ${(similarity * 100).toFixed(2)}%)`, 'success');
                            
                            // 高亮显示匹配的用户
                            highlightUser(bestMatch.faceId);
                        } else {
                            showRecognitionResult('未识别到匹配的用户', 'warning');
                        }
                        // 显示"再次识别"按钮
                        showRecognizeAgainButton();
                    } else {
                        throw new Error(result.message || '识别失败');
                    }
                } catch (error) {
                    console.error('人脸识别失败:', error);
                    showResult('人脸识别失败: ' + error.message, 'error');
                }
            }

            function showRecognizeAgainButton() {
                let container = document.getElementById('result-container');
                const btnId = 'recognize-again-btn';
                if (!document.getElementById(btnId)) {
                    const btn = document.createElement('button');
                    btn.id = btnId;
                    btn.className = 'btn btn-neo btn-neo-primary mt-2';
                    btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> 再次识别';
                    btn.onclick = () => {
                        console.log('Recognize again button clicked');
                        hasRecognizedOnce = false;
                        currentOperation = 'recognize';
                        // 再次识别：只允许下一次自动拍照
                        allowAutoCapture = true;
                        autoCaptureAgain();
                    };
                    container.appendChild(btn);
                }
            }

            function autoCaptureAgain() {
                console.log('autoCaptureAgain called');
                // 立即触发一次"人脸保持"提示并等待下一次自动拍照
                const holdStillIndicator = document.getElementById('hold-still-indicator');
                if (holdStillIndicator) holdStillIndicator.classList.add('active');
                // 清空上一次拍照
                currentFaceImage = null;
                // 重置所有相关状态
                hasRecognizedOnce = false;
                allowAutoCapture = true;
                detectionEnabled = true;
            }

            // 高亮显示用户
            function highlightUser(faceId) {
                // 不再自动关闭摄像头弹框，保持结果可见
                
                const rows = document.querySelectorAll('#user-list tr');
                rows.forEach(row => {
                    row.classList.remove('highlight');
                    const button = row.querySelector('.update-user');
                    if (button) {
                        // 注意：这里需要根据实际情况调整，因为数据库中的用户可能没有直接存储faceId
                        // 这里简化处理，实际应用中需要更准确的匹配方式
                        row.classList.add('highlight');
                        // 滚动到该行
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }

            // 显示操作结果
            function showResult(message, type) {
                const resultContainer = document.getElementById('result-container');
                let className = 'alert ';
                
                switch (type) {
                    case 'success':
                        className += 'alert-success';
                        break;
                    case 'error':
                        className += 'alert-danger';
                        break;
                    case 'warning':
                        className += 'alert-warning';
                        break;
                    default:
                        className += 'alert-info';
                }
                
                resultContainer.innerHTML = `<div class="${className}">${message}</div>`;
            }
            
            // 显示识别结果（优化版）
            function showRecognitionResult(message, type) {
                const resultContainer = document.getElementById('result-container');
                let className = 'recognition-result result-';
                
                switch (type) {
                    case 'success':
                        className += 'success';
                        break;
                    case 'warning':
                        className += 'warning';
                        break;
                    default:
                        className += 'info';
                }
                
                resultContainer.innerHTML = `<div class="${className}">${message}</div>`;
            }
            
            // 当模态框关闭时，停止检测
            document.getElementById('cameraModal').addEventListener('hidden.bs.modal', function () {
                console.log('Camera modal hidden, cleaning up');
                detectionEnabled = false;
                if (faceDetectionInterval) {
                    clearInterval(faceDetectionInterval);
                    faceDetectionInterval = null;
                }
                if (autoCaptureTimer) {
                    clearTimeout(autoCaptureTimer);
                    autoCaptureTimer = null;
                }
                // 清除检测框
                document.getElementById('detection-overlay').innerHTML = '';
                // 重置所有状态标志
                allowAutoCapture = false;
                currentOperation = '';
                originModalId = null;
                // 重置识别状态
                hasRecognizedOnce = false;
                // 清除人脸图像
                currentFaceImage = null;
            });

    </script>
</body>
</html>